# 競馬風チケット購入システム 要求仕様書

## 1. 概要

本システムは、競馬を模したチケット購入および賞金獲得機能を提供するAPIサーバーである。ユーザーはレースの勝者を予測するチケットを購入し、管理者はレース結果を登録する。結果に応じて、ユーザーは賞金を獲得できる。

## 2. システム構成

- **開発言語:** Python
- **フレームワーク:** FastAPI

## 3. 登場人物 (アクター)

- **ユーザー:** システムの一般利用者。チケットの購入や結果の確認を行う。
- **管理者:** システムの管理者。レース結果の登録を行う。

## 4. 機能要件

### 4.1. 共通要件

- APIにアクセスする際、パスパラメータでユーザー名 (`/users/{username}/...`) または管理者 (`/admin/...`) を指定する。
- 1レースあたりの出馬数は **4** とする。

### 4.2. ユーザー機能

- **チケット購入機能**
    - ユーザーは、指定したレースに対してチケットを購入できる。
    - 購入できるチケットは以下の2種類とする。
        1.  **単勝:** 1着になる馬を1頭選択する。
        2.  **3連単:** 1着、2着、3着になる馬を着順通りに3頭選択する。
- **賞金獲得機能**
    - 購入したチケットがレース結果と一致した場合、所定の賞金を獲得できる。
    - (将来的な展望: オッズや掛け金に応じた配当計算)

### 4.3. 管理者機能

- **レース結果登録機能**
    - 管理者は、各レースの着順結果 (1着から4着まで) を登録できる。

## 5. APIエンドポイント設計 (案)

### 5.1. ユーザー向けエンドポイント

- `POST /users/{username}/tickets`
    - **説明:** ユーザーがチケットを購入する。
    - **リクエストボディ:**
        ```json
        {
          "race_id": 1,
          "ticket_type": "trifecta", // "win" or "trifecta"
          "picks": [3, 1, 4] // 単勝の場合は [3] のように1頭、3連単の場合は [3, 1, 4] のように3頭
        }
        ```
    - **レスポンス:**
        ```json
        {
          "message": "Ticket purchased successfully.",
          "ticket_id": 101
        }
        ```

- `GET /users/{username}/tickets`
    - **説明:** ユーザーが購入したチケットの一覧と状態（的中、ハズレ、未確定）を確認する。
    - **レスポンス:**
        ```json
        [
          {
            "ticket_id": 101,
            "race_id": 1,
            "ticket_type": "trifecta",
            "picks": [3, 1, 4],
            "status": "pending" // "pending", "won", "lost"
          }
        ]
        ```

### 5.2. 管理者向けエンドポイント

- `POST /admin/races/{race_id}/results`
    - **説明:** 管理者がレースの結果を登録する。
    - **リクエストボディ:**
        ```json
        {
          "results": [2, 4, 1, 3] // 1着、2着、3着、4着の馬番のリスト
        }
        ```
    - **レスポンス:**
        ```json
        {
          "message": "Race results for race_id 1 have been recorded."
        }
        ```

### 5.3. 一般向けエンドポイント

- `GET /races/{race_id}`
    - **説明:** 特定のレース情報を取得する（結果が確定していれば結果も含む）。
    - **レスポンス:**
        ```json
        {
          "race_id": 1,
          "race_name": "第1レース",
          "horses": [1, 2, 3, 4],
          "results": [2, 4, 1, 3] // 未確定の場合は null
        }
        ```

## 6. データモデル (案)

- **User:**
    - `username` (string, PK)
    - `balance` (integer)
- **Race:**
    - `race_id` (integer, PK)
    - `results` (array of integer, nullable)
- **Ticket:**
    - `ticket_id` (integer, PK)
    - `user_id` (string, FK)
    - `race_id` (integer, FK)
    - `ticket_type` (string)
    - `picks` (array of integer)
    - `status` (string)

## 7. その他

- 認証・認可は、本仕様書の範囲ではユーザー名による簡易的な識別のみとする。複雑な認証メカニズムは含めない。
